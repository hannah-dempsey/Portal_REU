---
title: "portal_analysis"
author: "Hannah Dempsey"
output: github_document
---

# Portal Analysis

Set up:

```{r}
library(tidyverse)
library(portalr, use_default_data_path("../data_raw/"))

#loading in portal data using portalr package
portal <- abundance(effort = T, level = "Treatment", type = "Rodents", shape = "Flat")

data_tables <- load_rodent_data()
species <- data_tables$species_table
trapping <- data_tables$trapping_table
plots <- data_tables$plots_table
```

Cleaning data:

```{r}
#adding species information
portal <- portal %>% 
  left_join(species, join_by(species)) %>% 
  mutate(effort = ntraps / nplots,
         abund_per_trapnight = abundance / effort) %>% 
  select(1:9, 21:22) %>% 
  rename(scientific_name = scientificname,
         common_name = commonname)
portal

#adding period dates
period_durations <- trapping %>% 
  mutate(date = make_date(year = year,
                         month = month,
                         day = day)) %>% 
  select(4:9) %>% 
  group_by(period) %>% 
  summarize(start_date = min(date),
            end_date = max(date))
period_durations

portal <- portal %>% 
  left_join(period_durations, join_by(period)) %>% 
  mutate(year = year(end_date),
         month = month(end_date)) %>% 
  select(14, 15, everything())
portal
```

### Abundance Data

Plotting abundance per trapnight for each period:

```{r}
portal %>% 
  filter(abund_per_trapnight != 0) %>% 
  ggplot(., aes(x = start_date, y = abund_per_trapnight)) +
  geom_point() +
  geom_line() +
  facet_wrap(~species) +
  labs(x = "Year", y = "Rodent Abundance per Trapnight", title = "Portal Project") +
  theme_bw()
```

Plotting abundance by year: REPLACE PERIOD WITH THIS GRAPH?

```{r}
portal %>% 
  group_by(year, species) %>% 
  summarize(abundance = sum(abundance),
            effort = sum(effort)) %>% 
  mutate(abund_per_trapnight = abundance / effort) %>% 
  ggplot(., aes(x = year, y = abund_per_trapnight)) +
  geom_point() +
  geom_line() +
  facet_wrap(~species) +
  labs(x = "Year", y = "Rodent Abundance per Trapnight", title = "Portal Project") +
  theme_bw()
```
